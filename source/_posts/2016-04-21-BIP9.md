title: 新的软分叉升级规范BIP9
date: 2016-04-21 13:09:52
tags:
---

比特币的软/硬分叉升级一直采用块的`version`字段来完成。由于是一个分布式系统，必然需要采用灰度发布模式。

### 传统的升级过程

在实施[BIP9](https://github.com/bitcoin/bips/blob/master/bip-0009.mediawiki)前是这样升级的，当前块版本为`version`，那么新块版本是`version + 1`，当近1000个块中的版本超过95%都是新版本时，则触发启用新特性，同时不再接收旧版本号的块。由于中间存在1000个块的窗口期，大约一周，所以给出足够的时间给当前网络中的节点实施升级。

![图1.0](https://cloud.githubusercontent.com/assets/514951/14696861/4a75b116-07b1-11e6-99da-0b28e3408614.png)

上图是来自[BTC.COM](https://chain.btc.com/stats/block-ver?history_mode=all#versionTrend)统计的比特币历史上几个升级过程，最近的v3升级v4的过程大约花费了一个半月左右。前面几次的升级时间更长。

这种依次递增版本号的方法，有一个明显的弊端：每次仅能进行一个特性升级。当需要同时进行多个升级时，则无法完成。BIP9的诞生就是为了解决这个问题的，同时把向下兼容性升级过程制定了规范。

### BIP9特征

1. 支持多个特性同时升级
1. 新增投票时间区间
1. 新增锁定期

块的`version`字段是4字节，意味着有32位比特，前三位目前固定为`001`，那么剩余29个比特可以用于特性设置，与激发某个特性，则将其对应的位设置为`1`。

```
二进制格式：

   001   0 0000 0000 0000 0000 0000 0000 0000
------   ------------------------------------
固定保留  29个特性标识位
```

### 状态变迁

BIP9某个特性的状态有：

* DEFINED `定义`。每个特性的升级设定会写到某一个版本的bitcoind中，并部署下去。
* STARTED `启动`。启动后会有两个可能的变迁状态：`LOCKED_IN`, `FAILED`。
* LOCKED_IN `锁定`。一旦进入锁定态，则必然会激活。锁定期为2016个块。
* ACTIVE `激活`
* FAILED `失败`

![图1.1](https://cloud.githubusercontent.com/assets/514951/14697672/a19038d4-07b8-11e6-9101-a20b009e102f.png)

`MTP`是最近11个块的时间戳中位数。区块链上的块时间并不是按照高度递增而严格递增的，但`MTP`时间是严格递增的(早期可能不能严格遵守)。

能够进入锁定期（即得到全网同意）的条件是在2016个块中，支持的块数量达到95%，在测试网络上是75%。窗口期从之前的1000提升至2016个块，即一个难度周期，约两周。同时，还增加了2016个块的锁定期，之后才能正式激活特性。这比之前的升级，变得更加稳健，预留出充分的时间，同时意味着特性的落地周期变长。

### 首个采用BIP9的软分叉

`BIP68/112/113`是首个采用BIP9方式进行升级的软分叉，随`bitcoind-v0.12.1`发布。使能位采用最右侧位，起始时间(_starttime_)是`2016-05-01 00:00:00`，终止时间(_timeout_)是`2017-05-01 00:00:00`。

若要支持`BIP68/112/113`软分叉，那么版本号应该是: `0x20000001`，二进制为：`0010 0000 0000 0000 0000 0000 0000 0001`。

另外`BIP109`(Classic 2MB HardFork)也是采用的是BIP9规范，使能位是最左侧位，但触发窗口期与锁定期的设定均未采用BIP9的定义。其版本号是：`0x30000000`，二进制为：`0011 0000 0000 0000 0000 0000 0000 0000`。

如果版本号为：`0x30000001`，二进制为：`0011 0000 0000 0000 0000 0000 0000 0001`，则意味着同时支持`BIP68/112/113`和`BIP109`。